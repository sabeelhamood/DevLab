name: ðŸš€ Production Deployment - Frontend to Vercel & Backend to Railway

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  FRONTEND_DIR: 'frontend'
  BACKEND_DIR: 'backend'

jobs:
  # ===========================================
  # FRONTEND DEPLOYMENT TO VERCEL
  # ===========================================
  deploy-frontend:
    name: ðŸŒ Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json
        
    - name: ðŸ” Validate Secrets
      run: |
        echo "ðŸ” Validating Vercel secrets..."
        if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
          echo "âŒ VERCEL_TOKEN is missing"
          exit 1
        fi
        if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
          echo "âŒ VERCEL_PROJECT_ID is missing"
          exit 1
        fi
        echo "âœ… All Vercel secrets validated"
        
    - name: ðŸ“¦ Install Frontend Dependencies
      working-directory: ${{ env.FRONTEND_DIR }}
      run: |
        echo "ðŸ“¦ Installing frontend dependencies..."
        npm ci --prefer-offline --no-audit
        
    - name: ðŸ§ª Run Frontend Tests
      working-directory: ${{ env.FRONTEND_DIR }}
      run: |
        echo "ðŸ§ª Running frontend tests..."
        npm run test --if-present || echo "âš ï¸ No tests configured"
        
    - name: ðŸ—ï¸ Build Frontend
      working-directory: ${{ env.FRONTEND_DIR }}
      run: |
        echo "ðŸ—ï¸ Building frontend for production..."
        npm run build
        
    - name: ðŸš€ Deploy to Vercel
      working-directory: ${{ env.FRONTEND_DIR }}
      run: |
        echo "ðŸš€ Deploying frontend to Vercel..."
        export VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
        export VERCEL_PROJECT_ID="${{ secrets.VERCEL_PROJECT_ID }}"
        
        # Install Vercel CLI
        npm install -g vercel@latest
        
        # Deploy to production
        if [ -n "${{ secrets.VERCEL_ORG_ID }}" ]; then
          echo "Using VERCEL_ORG_ID for deployment"
          vercel --prod --yes --token="${{ secrets.VERCEL_TOKEN }}" --scope="${{ secrets.VERCEL_ORG_ID }}"
        else
          echo "Deploying without ORG_ID (using default scope)"
          vercel --prod --yes --token="${{ secrets.VERCEL_TOKEN }}"
        fi
        
        echo "âœ… Frontend deployed to Vercel successfully"
        
    - name: ðŸ“Š Get Deployment URL
      id: vercel-url
      run: |
        echo "ðŸ”— Getting Vercel deployment URL..."
        # Get the latest deployment URL
        DEPLOYMENT_URL=$(vercel ls --token="${{ secrets.VERCEL_TOKEN }}" --json | jq -r '.[0].url' 2>/dev/null || echo "https://${{ secrets.VERCEL_PROJECT_ID }}.vercel.app")
        echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        echo "ðŸŒ Frontend URL: $DEPLOYMENT_URL"
        
    - name: ðŸ§ª Smoke Test Frontend
      run: |
        echo "ðŸ§ª Running frontend smoke tests..."
        FRONTEND_URL="${{ steps.vercel-url.outputs.url }}"
        if curl -f -s "$FRONTEND_URL" > /dev/null; then
          echo "âœ… Frontend is accessible at: $FRONTEND_URL"
        else
          echo "âŒ Frontend smoke test failed"
          exit 1
        fi

  # ===========================================
  # BACKEND DEPLOYMENT TO RAILWAY
  # ===========================================
  deploy-backend:
    name: ðŸš‚ Deploy Backend to Railway
    runs-on: ubuntu-latest
    environment: production
    needs: deploy-frontend
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ env.BACKEND_DIR }}/package-lock.json
        
    - name: ðŸ” Validate Secrets
      run: |
        echo "ðŸ” Validating Railway secrets..."
        if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
          echo "âŒ RAILWAY_TOKEN is missing"
          exit 1
        fi
        if [ -z "${{ secrets.RAILWAY_PROJECT_ID }}" ]; then
          echo "âŒ RAILWAY_PROJECT_ID is missing"
          exit 1
        fi
        echo "âœ… All Railway secrets validated"
        
    - name: ðŸ“¦ Install Backend Dependencies
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        echo "ðŸ“¦ Installing backend dependencies..."
        npm ci --prefer-offline --no-audit
        
    - name: ðŸ§ª Run Backend Tests
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        echo "ðŸ§ª Running backend tests..."
        npm run test --if-present || echo "âš ï¸ No tests configured"
        
    - name: ðŸ—ï¸ Build Backend
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        echo "ðŸ—ï¸ Building backend for production..."
        npm run build
        
    - name: ðŸš‚ Deploy to Railway
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        echo "ðŸš‚ Deploying backend to Railway..."
        
        # Install Railway CLI
        npm install -g @railway/cli@latest
        
        # Login to Railway
        railway login --token="${{ secrets.RAILWAY_TOKEN }}"
        
        # Set environment variables
        if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
          echo "Setting GEMINI_API_KEY from GitHub secrets"
          railway variables set GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" --service="${{ secrets.RAILWAY_SERVICE_ID }}"
        else
          echo "Using existing GEMINI_API_KEY from Railway environment"
        fi
        
        # Set production environment variables
        railway variables set NODE_ENV="production" --service="${{ secrets.RAILWAY_SERVICE_ID }}"
        railway variables set PORT="3001" --service="${{ secrets.RAILWAY_SERVICE_ID }}"
        
        # Deploy to Railway
        if [ -n "${{ secrets.RAILWAY_SERVICE_ID }}" ]; then
          echo "Deploying to specific service: ${{ secrets.RAILWAY_SERVICE_ID }}"
          railway up --service="${{ secrets.RAILWAY_SERVICE_ID }}" --detach
        else
          echo "Deploying to default service in project"
          railway up --detach
        fi
        
        echo "âœ… Backend deployed to Railway successfully"
        
    - name: ðŸ“Š Get Deployment URL
      id: railway-url
      run: |
        echo "ðŸ”— Getting Railway deployment URL..."
        # Get the service URL
        SERVICE_URL=$(railway status --json | jq -r '.deployments[0].url' 2>/dev/null || echo "https://${{ secrets.RAILWAY_PROJECT_ID }}.up.railway.app")
        echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
        echo "ðŸš‚ Backend URL: $SERVICE_URL"
        
    - name: ðŸ§ª Smoke Test Backend
      run: |
        echo "ðŸ§ª Running backend smoke tests..."
        BACKEND_URL="${{ steps.railway-url.outputs.url }}"
        if curl -f -s "$BACKEND_URL/health" > /dev/null; then
          echo "âœ… Backend health check passed at: $BACKEND_URL/health"
        else
          echo "âŒ Backend smoke test failed"
          exit 1
        fi

  # ===========================================
  # INTEGRATION TESTING
  # ===========================================
  integration-test:
    name: ðŸ”— Integration Testing
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    
    steps:
    - name: ðŸ”— Test Frontend-Backend Integration
      run: |
        echo "ðŸ”— Testing frontend-backend integration..."
        FRONTEND_URL="${{ needs.deploy-frontend.outputs.url }}"
        BACKEND_URL="${{ needs.deploy-backend.outputs.url }}"
        
        echo "ðŸŒ Frontend URL: $FRONTEND_URL"
        echo "ðŸš‚ Backend URL: $BACKEND_URL"
        
        # Test API connectivity
        if curl -f -s "$BACKEND_URL/api/health" > /dev/null; then
          echo "âœ… Backend API is accessible"
        else
          echo "âŒ Backend API test failed"
          exit 1
        fi
        
        echo "âœ… Integration tests passed"

  # ===========================================
  # DEPLOYMENT SUMMARY
  # ===========================================
  deployment-summary:
    name: ðŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, integration-test]
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Frontend (Vercel)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ needs.deploy-frontend.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš‚ Backend (Railway)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ needs.deploy-backend.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Integration" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Deployment Status" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.deploy-frontend.result }}" = "success" ] && [ "${{ needs.deploy-backend.result }}" = "success" ] && [ "${{ needs.integration-test.result }}" = "success" ]; then
          echo "âœ… **All deployments successful!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some deployments failed. Check logs above.**" >> $GITHUB_STEP_SUMMARY
        fi
