name: ðŸš€ CI/CD Pipeline - Deploy to Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ===========================================
  # TEST SUITE
  # ===========================================
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        component: [backend, frontend]
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ matrix.component }}/package-lock.json
        
    - name: ðŸ“¦ Install Dependencies
      working-directory: ${{ matrix.component }}
      run: npm ci
      
    - name: ðŸ§ª Run Tests
      working-directory: ${{ matrix.component }}
      run: npm test --if-present || echo "âš ï¸ No tests configured"
      env:
        NODE_ENV: test
        CI: true

  # ===========================================
  # FRONTEND DEPLOYMENT TO VERCEL
  # ===========================================
  deploy-frontend:
    name: ðŸŒ Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ðŸ” Validate Vercel Token
      run: |
        echo "ðŸ” Validating Vercel token..."
        if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
          echo "âŒ VERCEL_TOKEN is missing in GitHub secrets"
          echo "âš ï¸  Please add VERCEL_TOKEN to GitHub repository secrets"
          echo "   Go to: Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
          exit 1
        fi
        echo "âœ… Vercel token validated"
        
    - name: ðŸ“¦ Install Frontend Dependencies
      working-directory: frontend
      run: npm ci
      
    - name: ðŸ—ï¸ Build Frontend
      working-directory: frontend
      run: npm run build
      
    - name: ðŸš€ Deploy to Vercel
      working-directory: frontend
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      run: |
        echo "ðŸš€ Deploying frontend to Vercel..."
        npm install -g vercel@latest
        
        # Read project configuration from .vercel/project.json
        if [ -f "../.vercel/project.json" ]; then
          PROJECT_ID=$(cat ../.vercel/project.json | grep -o '"projectId":"[^"]*' | cut -d'"' -f4)
          ORG_ID=$(cat ../.vercel/project.json | grep -o '"orgId":"[^"]*' | cut -d'"' -f4)
          
          echo "ðŸ“‹ Project ID: $PROJECT_ID"
          echo "ðŸ“‹ Org ID: $ORG_ID"
          
          # Copy .vercel folder to frontend directory for Vercel CLI to detect it
          if [ ! -d ".vercel" ]; then
            mkdir -p .vercel
            cp ../.vercel/project.json .vercel/project.json 2>/dev/null || echo "âš ï¸ Could not copy project.json"
          fi
          
          # Deploy using explicit project and org IDs
          vercel --prod --yes --token="$VERCEL_TOKEN" --scope="$ORG_ID"
        else
          echo "âš ï¸ .vercel/project.json not found, attempting deployment without explicit config"
          vercel --prod --yes --token="$VERCEL_TOKEN"
        fi
        
        echo "âœ… Frontend deployed to Vercel successfully"
        
    - name: ðŸ“Š Get Deployment URL
      id: vercel-url
      run: |
        # Get project ID from .vercel/project.json or use secret
        if [ -f "../.vercel/project.json" ]; then
          PROJECT_ID=$(cat ../.vercel/project.json | grep -o '"projectId":"[^"]*' | cut -d'"' -f4)
          if [ -n "$PROJECT_ID" ]; then
            echo "url=https://dev-lab-phi.vercel.app" >> $GITHUB_OUTPUT
            echo "ðŸŒ Frontend URL: https://dev-lab-phi.vercel.app"
          else
            echo "url=https://dev-lab-phi.vercel.app" >> $GITHUB_OUTPUT
            echo "ðŸŒ Frontend URL: https://dev-lab-phi.vercel.app"
          fi
        else
          echo "url=https://dev-lab-phi.vercel.app" >> $GITHUB_OUTPUT
          echo "ðŸŒ Frontend URL: https://dev-lab-phi.vercel.app"
        fi

  # ===========================================
  # BACKEND DEPLOYMENT TO RAILWAY
  # ===========================================
  deploy-backend:
    name: ðŸš‚ Deploy Backend to Railway
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: ðŸ” Validate Railway Secrets
      run: |
        echo "ðŸ” Validating Railway secrets..."
        if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
          echo "âŒ RAILWAY_TOKEN is missing"
          exit 1
        fi
        if [ -z "${{ secrets.RAILWAY_PROJECT_ID }}" ]; then
          echo "âŒ RAILWAY_PROJECT_ID is missing"
          exit 1
        fi
        echo "âœ… All Railway secrets validated"
        
    - name: ðŸ“¦ Install Backend Dependencies
      working-directory: backend
      run: npm ci
      
    - name: ðŸš‚ Deploy to Railway
      working-directory: backend
      run: |
        echo "ðŸš‚ Deploying backend to Railway..."
        
        # Install Railway CLI
        curl -fsSL https://railway.app/install.sh | sh
        echo "$HOME/.railway/bin" >> $GITHUB_PATH
        
        # Login to Railway
        railway login --token="${{ secrets.RAILWAY_TOKEN }}"
        
        # Set environment variables if provided
        if [ -n "${{ secrets.RAILWAY_SERVICE_ID }}" ]; then
          if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
            railway variables set GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" --service="${{ secrets.RAILWAY_SERVICE_ID }}"
          fi
          railway variables set NODE_ENV="production" --service="${{ secrets.RAILWAY_SERVICE_ID }}"
          railway variables set PORT="3001" --service="${{ secrets.RAILWAY_SERVICE_ID }}"
          
          # Deploy to Railway
          railway up --service="${{ secrets.RAILWAY_SERVICE_ID }}" --detach
        else
          railway variables set NODE_ENV="production"
          railway variables set PORT="3001"
          railway up --detach
        fi
        
        echo "âœ… Backend deployed to Railway successfully"
        
    - name: ðŸ“Š Get Deployment URL
      id: railway-url
      run: |
        echo "url=https://${{ secrets.RAILWAY_PROJECT_ID }}.up.railway.app" >> $GITHUB_OUTPUT
        echo "ðŸš‚ Backend URL: https://${{ secrets.RAILWAY_PROJECT_ID }}.up.railway.app"

  # ===========================================
  # DEPLOYMENT SUMMARY
  # ===========================================
  deployment-summary:
    name: ðŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always() && github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    
    steps:
    - name: ðŸ“‹ Generate Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Frontend (Vercel)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://dev-lab-phi.vercel.app" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš‚ Backend (Railway)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://${{ secrets.RAILWAY_PROJECT_ID }}.up.railway.app" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.deploy-frontend.result }}" = "success" ] && [ "${{ needs.deploy-backend.result }}" = "success" ]; then
          echo "âœ… **All deployments successful!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some deployments failed. Check logs above.**" >> $GITHUB_STEP_SUMMARY
        fi
