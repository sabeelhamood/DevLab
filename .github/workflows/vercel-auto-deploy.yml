name: üöÄ Vercel Auto-Deploy (Native Integration Backup)

# This workflow ensures deployments happen even if native integration fails
# It's a backup mechanism that triggers on every push to main
on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/vercel-auto-deploy.yml'
  workflow_dispatch:

jobs:
  trigger-vercel-deploy:
    name: Trigger Vercel Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Vercel Secrets
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "‚ö†Ô∏è VERCEL_TOKEN not set - relying on native integration"
            exit 0
          fi
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "‚ö†Ô∏è VERCEL_PROJECT_ID not set - relying on native integration"
            exit 0
          fi
          echo "‚úÖ Vercel secrets available"

      - name: Get Latest Commit
        id: commit
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "üìã Commit: $(git rev-parse HEAD)"
          echo "üìã Message: $(git log -1 --pretty=%B)"

      - name: Trigger Vercel Deployment via API
        if: env.VERCEL_TOKEN != ''
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "üöÄ Triggering Vercel deployment via API (backup method)..."
          
          # Trigger deployment with git source
          RESPONSE=$(curl -X POST "https://api.vercel.com/v13/deployments" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"projectId\": \"$VERCEL_PROJECT_ID\",
              \"target\": \"production\",
              \"gitSource\": {
                \"type\": \"github\",
                \"repo\": \"sabeelhamood/DevLab\",
                \"ref\": \"main\",
                \"sha\": \"${{ steps.commit.outputs.sha }}\"
              }
            }" \
            -w "\nHTTP_STATUS:%{http_code}" \
            -s)
          
          HTTP_STATUS=$(echo "$RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
          
          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
            echo "‚úÖ Deployment triggered successfully via API"
            DEPLOYMENT_URL=$(echo "$BODY" | grep -o '"url":"[^"]*' | head -1 | cut -d'"' -f4)
            if [ -n "$DEPLOYMENT_URL" ]; then
              echo "üåê Deployment URL: $DEPLOYMENT_URL"
            fi
          else
            echo "‚ö†Ô∏è API trigger failed, but native integration should handle it"
            echo "Response: $BODY"
          fi

      - name: Verify Deployment Status
        run: |
          echo "‚úÖ Deployment process completed"
          echo "üìã Commit: ${{ steps.commit.outputs.sha }}"
          echo "üìã Message: ${{ steps.commit.outputs.message }}"
          echo ""
          echo "üîç Check Vercel dashboard for deployment status:"
          echo "   https://vercel.com/dashboard"
          echo ""
          echo "üåê Your site: https://dev-lab-gules.vercel.app/"

