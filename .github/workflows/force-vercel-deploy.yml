name: üöÄ Force Vercel Deployment

# Trigger manually or on push to main
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  force-deploy:
    name: Force Fresh Vercel Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "‚ùå VERCEL_TOKEN is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "‚ùå VERCEL_PROJECT_ID is not set"
            exit 1
          fi
          echo "‚úÖ Secrets validated"

      - name: Get Latest Commit Info
        id: commit
        run: |
          echo "commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "üìã Commit: $(git rev-parse HEAD)"
          echo "üìã Message: $(git log -1 --pretty=%B)"

      - name: Trigger Vercel Deployment via API
        run: |
          echo "üöÄ Triggering Vercel deployment via API..."
          
          GIT_REF="${{ steps.commit.outputs.commit }}"
          PROJECT_ID="${{ secrets.VERCEL_PROJECT_ID }}"
          VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
          
          echo "üìã Project ID: $PROJECT_ID"
          echo "üìã Git Ref: $GIT_REF"
          
          # Trigger deployment
          RESPONSE=$(curl -X POST "https://api.vercel.com/v13/deployments" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"projectId\": \"$PROJECT_ID\",
              \"target\": \"production\",
              \"gitSource\": {
                \"type\": \"github\",
                \"repo\": \"sabeelhamood/DevLab\",
                \"ref\": \"main\",
                \"sha\": \"$GIT_REF\"
              }
            }" \
            -w "\nHTTP_STATUS:%{http_code}" \
            -s)
          
          HTTP_STATUS=$(echo "$RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
          
          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
            echo "‚úÖ Deployment triggered successfully!"
            DEPLOYMENT_URL=$(echo "$BODY" | grep -o '"url":"[^"]*' | head -1 | cut -d'"' -f4)
            if [ -n "$DEPLOYMENT_URL" ]; then
              echo "üåê Deployment URL: $DEPLOYMENT_URL"
            fi
          else
            echo "‚ùå Deployment trigger failed"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Wait for Deployment
        run: |
          echo "‚è≥ Waiting 30 seconds for deployment to start..."
          sleep 30
          echo "‚úÖ Deployment should be in progress. Check Vercel dashboard for status."

