<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CodeMirror Editor with Judge0</title>

  <!-- CodeMirror core -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>

  <!-- Languages -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script> <!-- Java, C, CPP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/php/php.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>

  <style>
    :root {
      --bg-page: #f8fafc;
      --bg-card: #ffffff;
      --bg-soft: #f1f5f9;

      --primary: #0F6B52;
      --primary-hover: #158863;
      --secondary: #2563eb;

      --text-main: #0f172a;
      --text-muted: #64748b;

      --radius-lg: 18px;
      --radius-md: 12px;

      --shadow-soft: 0 8px 24px rgba(15,23,42,0.08);
      --shadow-card: 0 16px 40px rgba(15,23,42,0.12);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 16px;
      background: linear-gradient(180deg, #f8fafc, #eef2f7);
    }
    .editor-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-card);
      animation: fadeUp 0.4s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      background: var(--bg-soft);
      padding: 14px 16px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.35);
    }
    .toolbar select {
      padding: 8px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 500;
      background: white;
      cursor: pointer;
    }
    .toolbar button {
      padding: 8px 16px;
      border: none;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 6px 14px rgba(15,23,42,0.15);
    }
    .toolbar button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-run {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
    }
    .btn-run:hover:not(:disabled) {
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
    }
    .btn-run-tests {
      background: linear-gradient(135deg, #0F6B52, #22c55e);
      color: white;
    }
    .btn-run-tests:hover:not(:disabled) {
      background: linear-gradient(135deg, #0a5540, #16a34a);
    }
    .btn-reset {
      background: #475569;
      color: white;
    }
    .btn-reset:hover:not(:disabled) {
      background: #334155;
    }
    .CodeMirror {
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: var(--radius-lg);
      height: 400px;
      font-size: 14px;
      font-family: 'JetBrains Mono','Fira Code',monospace;
      box-shadow: var(--shadow-soft);
    }
    .result-container {
      margin-top: 16px;
      padding: 12px;
      border-radius: var(--radius-md);
      font-size: 14px;
      display: none;
      box-shadow: var(--shadow-soft);
    }
    .result-container.show {
      display: block;
    }
    .result-success {
      background: linear-gradient(135deg,#ecfdf5,#d1fae5);
      color: #065f46;
      border: 1px solid #10b981;
    }
    .result-error {
      background: linear-gradient(135deg,#fef2f2,#fee2e2);
      color: #991b1b;
      border: 1px solid #ef4444;
    }
    .result-info {
      background: linear-gradient(135deg,#eff6ff,#dbeafe);
      color: #1e40af;
      border: 1px solid #3b82f6;
    }
    .test-results {
      margin-top: 16px;
      display: none;
    }
    .test-results.show {
      display: block;
    }
    .test-result-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: var(--radius-md);
      border: 1px solid #e5e7eb;
      box-shadow: var(--shadow-soft);
    }
    .test-result-passed {
      background: #d1fae5;
      border-color: #10b981;
    }
    .test-result-failed {
      background: #fee2e2;
      border-color: #ef4444;
    }
    .test-result-header {
      font-weight: 600;
      margin-bottom: 8px;
    }
    .test-result-details {
      font-size: 13px;
      margin-top: 8px;
    }
    .test-result-details pre {
      margin: 4px 0;
      padding: 8px;
      background: #f3f4f6;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="editor-container">
    <div class="toolbar">
  <select id="languageSelect">
        <option value="" selected disabled>Select Language</option>
    <option value="javascript">JavaScript</option>
    <option value="python">Python</option>
    <option value="text/x-csrc">C</option>
    <option value="text/x-c++src">C++</option>
    <option value="text/x-java">Java</option>
    <option value="php">PHP</option>
    <option value="xml">HTML / XML</option>
    <option value="css">CSS</option>
  </select>
      <button id="runBtn" class="btn-run">â–¶ Run</button>
      <button id="runTestsBtn" class="btn-run-tests">ðŸ§ª Run All Tests</button>
      <button id="resetBtn" class="btn-reset">â†» Reset</button>
    </div>

    <textarea id="editor">// Please select a programming language to begin</textarea>

    <div id="resultContainer" class="result-container"></div>

    <div id="testResults" class="test-results"></div>
  </div>

  <script>
    // Initialize test cases (will be injected by buildCodeMirrorTemplateForQuestion)
    const tests = [];
    
    // Initialize expectsReturn flag (will be injected by buildCodeMirrorTemplateForQuestion)
    const expectsReturn = false;

    // Create editor in neutral state (no language selected yet)
    const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
      lineNumbers: true,
      mode: null, // No syntax highlighting until language is selected
      theme: "default",
      readOnly: false
    });
    
    let isLanguageSelected = false;

    // Map CodeMirror modes to Judge0 language names
    const languageMap = {
      'javascript': 'javascript',
      'python': 'python',
      'text/x-csrc': 'c',
      'text/x-c++src': 'cpp',
      'text/x-java': 'java',
      'php': 'php',
      'xml': 'xml',
      'css': 'css'
    };

    // Get current Judge0 language from CodeMirror mode
    function getJudge0Language() {
      const mode = editor.getOption('mode');
      if (!mode) {
        throw new Error('Please select a programming language first');
      }
      const judge0Lang = languageMap[mode] || 'javascript';
      console.log('CodeMirror mode:', mode, '-> Judge0 language:', judge0Lang);
      return judge0Lang;
    }
    
    // Get default code for a specific CodeMirror mode
    function getDefaultCodeForMode(mode) {
      const defaultCodes = {
        'javascript': 'console.log("Hello!");',
        'python': 'print("Hello!")',
        'text/x-csrc': '#include <stdio.h>\n\nint main() {\n    printf("Hello!\\n");\n    return 0;\n}',
        'text/x-c++src': '#include <iostream>\n\nint main() {\n    std::cout << "Hello!" << std::endl;\n    return 0;\n}',
        'text/x-java': 'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello!");\n    }\n}',
        'php': '<?php\necho "Hello!";\n?>',
        'xml': '<html>\n  <body>Hello!</body>\n</html>',
        'css': 'body { color: blue; }'
      };
      return defaultCodes[mode] || 'console.log("Hello!");';
    }

    // Expose getCode function to parent window
    window.getCode = function() {
      return editor.getValue();
    };

    // Get API base URL from parent window or construct from location
    function getApiBaseUrl() {
      let apiBase = null;
      
      // Try to get from parent window global variable
      try {
        if (window.parent && window.parent.__DEVLAB_API_BASE__) {
          apiBase = window.parent.__DEVLAB_API_BASE__;
          if (apiBase && typeof apiBase === 'string' && apiBase.trim()) {
            console.log('[getApiBaseUrl] Using parent __DEVLAB_API_BASE__:', apiBase);
            return apiBase.trim();
          }
        }
      } catch (e) {
        console.warn('[getApiBaseUrl] Cross-origin restriction accessing parent __DEVLAB_API_BASE__:', e.message);
      }
      
      // Try to get from parent window location
      try {
        if (window.parent && window.parent.location) {
          const parentOrigin = window.parent.location.origin;
          if (parentOrigin) {
            console.log('[getApiBaseUrl] Using parent location.origin:', parentOrigin);
            return parentOrigin;
          }
        }
      } catch (e) {
        console.warn('[getApiBaseUrl] Cross-origin restriction accessing parent location:', e.message);
      }
      
      // Fallback: construct from current location
      const currentUrl = window.location.href;
      if (currentUrl.includes('localhost') || currentUrl.includes('127.0.0.1')) {
        const fallback = 'http://localhost:3000';
        console.log('[getApiBaseUrl] Using localhost fallback:', fallback);
        return fallback;
      }
      
      // Try to extract origin from current location
      try {
        const currentOrigin = window.location.origin;
        if (currentOrigin) {
          console.log('[getApiBaseUrl] Using current location.origin:', currentOrigin);
          return currentOrigin;
        }
      } catch (e) {
        console.warn('[getApiBaseUrl] Error getting current origin:', e.message);
      }
      
      console.error('[getApiBaseUrl] Could not determine API base URL');
      return '';
    }

    // Build API URL
    function buildUrl(path) {
      if (!path || typeof path !== 'string') {
        console.error('[buildUrl] Invalid path:', path);
        return '';
      }
      
      // If path is already a full URL, return it
      if (/^https?:\/\//i.test(path)) {
        console.log('[buildUrl] Path is already full URL:', path);
        return path;
      }
      
      const base = getApiBaseUrl();
      if (!base || base.trim() === '') {
        console.error('[buildUrl] No API base URL available. Cannot build URL for path:', path);
        throw new Error('API base URL is not configured. Please check your backend connection.');
      }
      
      const normalized = path.startsWith('/') ? path : '/' + path;
      const fullUrl = base.replace(/\/+$/, '') + normalized;
      console.log('[buildUrl] Built URL:', fullUrl);
      return fullUrl;
    }

    // Get service headers from parent window
    function getServiceHeaders() {
      try {
        if (window.parent && window.parent.__DEVLAB_SERVICE_HEADERS) {
          const headers = window.parent.__DEVLAB_SERVICE_HEADERS;
          if (typeof headers === 'object' && headers !== null) {
            const serviceHeaders = { ...headers };
            console.log('[getServiceHeaders] Retrieved service headers:', Object.keys(serviceHeaders));
            return serviceHeaders;
          }
        }
      } catch (e) {
        console.warn('[getServiceHeaders] Cross-origin restriction accessing parent headers:', e.message);
      }
      console.log('[getServiceHeaders] No service headers available, using empty object');
      return {};
    }

    // Display result message
    function showResult(message, type = 'info') {
      const container = document.getElementById('resultContainer');
      container.textContent = message;
      container.className = 'result-container show result-' + type;
    }

    // Hide result
    function hideResult() {
      const container = document.getElementById('resultContainer');
      container.className = 'result-container';
    }

    // Render test results
    function renderTestResults(results) {
      const container = document.getElementById('testResults');
      container.innerHTML = '';
      
      if (!results || results.length === 0) {
        container.className = 'test-results';
        return;
      }

      container.className = 'test-results show';

      const total = results.length;
      const passed = results.filter(r => r.passed).length;

      const summary = document.createElement('div');
      summary.style.cssText = 'font-weight: 600; font-size: 16px; margin-bottom: 12px; padding: 12px; background: #f3f4f6; border-radius: 6px;';
      summary.textContent = `Test Results: ${passed}/${total} tests passed`;
      container.appendChild(summary);

      results.forEach((result, index) => {
        const item = document.createElement('div');
        item.className = 'test-result-item ' + (result.passed ? 'test-result-passed' : 'test-result-failed');
        
        const header = document.createElement('div');
        header.className = 'test-result-header';
        header.textContent = `Test ${result.testNumber || (index + 1)}: ${result.passed ? 'âœ… PASSED' : 'âŒ FAILED'}`;
        item.appendChild(header);

        const details = document.createElement('div');
        details.className = 'test-result-details';
        
        if (result.input !== undefined) {
          const inputLabel = document.createElement('div');
          inputLabel.textContent = 'Input:';
          inputLabel.style.cssText = 'font-weight: 600; margin-top: 8px;';
          details.appendChild(inputLabel);
          const inputPre = document.createElement('pre');
          inputPre.textContent = typeof result.input === 'object' ? JSON.stringify(result.input, null, 2) : String(result.input);
          details.appendChild(inputPre);
        }

        if (result.expected !== undefined) {
          const expectedLabel = document.createElement('div');
          expectedLabel.textContent = 'Expected:';
          expectedLabel.style.cssText = 'font-weight: 600; margin-top: 8px;';
          details.appendChild(expectedLabel);
          const expectedPre = document.createElement('pre');
          expectedPre.textContent = typeof result.expected === 'object' ? JSON.stringify(result.expected, null, 2) : String(result.expected);
          details.appendChild(expectedPre);
        }

        if (result.result !== undefined) {
          const resultLabel = document.createElement('div');
          resultLabel.textContent = 'Got:';
          resultLabel.style.cssText = 'font-weight: 600; margin-top: 8px;';
          details.appendChild(resultLabel);
          const resultPre = document.createElement('pre');
          resultPre.textContent = typeof result.result === 'object' ? JSON.stringify(result.result, null, 2) : String(result.result);
          details.appendChild(resultPre);
        }

        if (result.stderr) {
          const errorLabel = document.createElement('div');
          errorLabel.textContent = 'Error:';
          errorLabel.style.cssText = 'font-weight: 600; margin-top: 8px; color: #dc2626;';
          details.appendChild(errorLabel);
          const errorPre = document.createElement('pre');
          errorPre.textContent = result.stderr;
          errorPre.style.cssText = 'color: #dc2626;';
          details.appendChild(errorPre);
        }

        if (result.status) {
          const statusLabel = document.createElement('div');
          statusLabel.textContent = 'Status: ' + result.status;
          statusLabel.style.cssText = 'margin-top: 8px; font-size: 12px; color: #6b7280;';
          details.appendChild(statusLabel);
        }

        item.appendChild(details);
        container.appendChild(item);
      });
    }

    // Run code (check compilation)
    async function runCode() {
      if (!isLanguageSelected) {
        showResult('Please select a programming language first.', 'error');
        return;
      }
      
      const code = editor.getValue();
      if (!code.trim() || code.trim() === '// Please select a programming language to begin') {
        showResult('Please write some code before running.', 'error');
        return;
      }

      const runBtn = document.getElementById('runBtn');
      let language;
      try {
        language = getJudge0Language();
        console.log('[runCode] Executing with language:', language, 'CodeMirror mode:', editor.getOption('mode'));
      } catch (error) {
        showResult(error.message, 'error');
        return;
      }

      try {
        runBtn.disabled = true;
        hideResult();
        document.getElementById('testResults').className = 'test-results';
        showResult('Running code via Judge0...', 'info');

        // Validate API base URL before making request
        const apiBase = getApiBaseUrl();
        if (!apiBase || apiBase.trim() === '') {
          throw new Error('API base URL is not configured. Cannot connect to backend.');
        }

        let endpoint;
        try {
          endpoint = buildUrl('/api/judge0/execute');
        } catch (urlError) {
          throw new Error('Failed to build API URL: ' + urlError.message);
        }

        if (!endpoint || endpoint.trim() === '') {
          throw new Error('Invalid API endpoint URL');
        }

        const headers = {
          'Content-Type': 'application/json',
          ...getServiceHeaders()
        };

        console.log('[runCode] Making request to:', endpoint);
        console.log('[runCode] Request payload:', { language, codeLength: code.length, expectsReturn });

        let response;
        try {
          response = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              sourceCode: code,
              language: language,
              input: '',
              expectedOutput: null,
              expectsReturn: expectsReturn
            })
          });
        } catch (fetchError) {
          console.error('[runCode] Fetch error:', fetchError);
          if (fetchError.name === 'TypeError' && fetchError.message.includes('fetch')) {
            throw new Error('Network error: Cannot connect to backend. Please check if the backend server is running and accessible.');
          }
          if (fetchError.name === 'TypeError' && fetchError.message.includes('CORS')) {
            throw new Error('CORS error: Backend server may not be configured to allow requests from this origin.');
          }
          throw new Error('Network request failed: ' + fetchError.message);
        }

        if (!response) {
          throw new Error('No response received from server');
        }

        let data;
        try {
          const responseText = await response.text();
          if (!responseText) {
            throw new Error('Empty response from server');
          }
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('[runCode] Response parse error:', parseError);
          throw new Error('Invalid response from server. Server may be down or returning an error page.');
        }

        if (!response.ok) {
          const errorMsg = data.error || data.message || `Server returned ${response.status} ${response.statusText}`;
          console.error('[runCode] Server error response:', { status: response.status, data });
          throw new Error(errorMsg);
        }

        if (data.success === false) {
          const errorMsg = data.error || 'Failed to execute code via Judge0';
          console.error('[runCode] API returned success=false:', data);
          throw new Error(errorMsg);
        }

        const result = data.result || data;
        const stdout = result.stdout || '';
        const stderr = result.stderr || result.compile_output || '';

        if (result.statusId === 3 || result.status === 'Accepted') {
          // Success
          if (stdout) {
            showResult('Output: ' + stdout.trim(), 'success');
          } else if (stderr) {
            showResult('Compiled successfully. Warnings: ' + stderr.trim(), 'info');
          } else {
            showResult('Code executed successfully (no output).', 'success');
          }
        } else {
          // Error
          const errorMsg = stderr || result.status || 'Execution failed';
          showResult('Error: ' + errorMsg, 'error');
        }
      } catch (error) {
        console.error('[runCode] Judge0 Run Code error:', error);
        const errorMessage = error.message || 'Unknown error';
        showResult('Failed to run code: ' + errorMessage, 'error');
      } finally {
        runBtn.disabled = false;
      }
    }

    // Run all test cases
    async function runAllTests() {
      if (!isLanguageSelected) {
        showResult('Please select a programming language first.', 'error');
        return;
      }
      
      const code = editor.getValue();
      if (!code.trim() || code.trim() === '// Please select a programming language to begin') {
        showResult('Please write some code before running tests.', 'error');
        return;
      }

      if (!tests || tests.length === 0) {
        showResult('No test cases available for this question.', 'error');
        return;
      }

      const runTestsBtn = document.getElementById('runTestsBtn');
      let language;
      try {
        language = getJudge0Language();
        console.log('[runAllTests] Executing with language:', language, 'CodeMirror mode:', editor.getOption('mode'));
      } catch (error) {
        showResult(error.message, 'error');
        return;
      }

      try {
        runTestsBtn.disabled = true;
        hideResult();
        document.getElementById('testResults').className = 'test-results';
        showResult('Running all tests via Judge0...', 'info');

        // Validate API base URL before making request
        const apiBase = getApiBaseUrl();
        if (!apiBase || apiBase.trim() === '') {
          throw new Error('API base URL is not configured. Cannot connect to backend.');
        }

        // Convert test cases to the format expected by the API
        const testCases = tests.map(tc => ({
          input: tc.input !== undefined ? tc.input : (tc.testInput !== undefined ? tc.testInput : ''),
          expected_output: tc.expectedOutput !== undefined ? tc.expectedOutput : (tc.expected_output !== undefined ? tc.expected_output : (tc.output !== undefined ? tc.output : ''))
        }));

        let endpoint;
        try {
          endpoint = buildUrl('/api/judge0/test-cases');
        } catch (urlError) {
          throw new Error('Failed to build API URL: ' + urlError.message);
        }

        if (!endpoint || endpoint.trim() === '') {
          throw new Error('Invalid API endpoint URL');
        }

        const headers = {
          'Content-Type': 'application/json',
          ...getServiceHeaders()
        };

        console.log('[runAllTests] Making request to:', endpoint);
        console.log('[runAllTests] Request payload:', { language, codeLength: code.length, testCasesCount: testCases.length, expectsReturn });

        let response;
        try {
          response = await fetch(endpoint, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              sourceCode: code,
              language: language,
              testCases: testCases,
              expectsReturn: expectsReturn
            })
          });
        } catch (fetchError) {
          console.error('[runAllTests] Fetch error:', fetchError);
          if (fetchError.name === 'TypeError' && fetchError.message.includes('fetch')) {
            throw new Error('Network error: Cannot connect to backend. Please check if the backend server is running and accessible.');
          }
          if (fetchError.name === 'TypeError' && fetchError.message.includes('CORS')) {
            throw new Error('CORS error: Backend server may not be configured to allow requests from this origin.');
          }
          throw new Error('Network request failed: ' + fetchError.message);
        }

        if (!response) {
          throw new Error('No response received from server');
        }

        let data;
        try {
          const responseText = await response.text();
          if (!responseText) {
            throw new Error('Empty response from server');
          }
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('[runAllTests] Response parse error:', parseError);
          throw new Error('Invalid response from server. Server may be down or returning an error page.');
        }

        if (!response.ok) {
          const errorMsg = data.error || data.message || `Server returned ${response.status} ${response.statusText}`;
          console.error('[runAllTests] Server error response:', { status: response.status, data });
          throw new Error(errorMsg);
        }

        if (data.success === false) {
          const errorMsg = data.error || 'Failed to run Judge0 test-cases';
          console.error('[runAllTests] API returned success=false:', data);
          throw new Error(errorMsg);
        }

        const results = Array.isArray(data.results) ? data.results : [];
        renderTestResults(results);

        const total = data.totalTests || results.length;
        const passed = typeof data.passedTests === 'number' ? data.passedTests : results.filter(r => r.passed).length;

        if (total > 0) {
          const allPassed = passed === total;
          const message = 'Judge0: ' + passed + '/' + total + ' tests passed.';
          showResult(message, allPassed ? 'success' : 'error');
        } else {
          showResult('Judge0: No test results returned.', 'error');
        }
      } catch (error) {
        console.error('[runAllTests] Judge0 Run All Tests error:', error);
        const errorMessage = error.message || 'Unknown error';
        showResult('Failed to run tests: ' + errorMessage, 'error');
        document.getElementById('testResults').className = 'test-results';
      } finally {
        runTestsBtn.disabled = false;
      }
    }

    // Reset editor
    function resetEditor() {
      if (!isLanguageSelected) {
        showResult('Please select a programming language first.', 'error');
        return;
      }
      
      const mode = editor.getOption('mode');
      const defaultCode = getDefaultCodeForMode(mode);
      editor.setValue(defaultCode);
      hideResult();
      document.getElementById('testResults').className = 'test-results';
      showResult('Editor reset. You can start fresh.', 'info');
      setTimeout(hideResult, 2000);
    }

    // Change mode based on <select>
    document.getElementById('languageSelect').addEventListener('change', function() {
      const mode = this.value;
      
      if (!mode || mode === '') {
        // "Select Language" was selected - reset to neutral state
        isLanguageSelected = false;
        editor.setOption('mode', null);
        editor.setValue('// Please select a programming language to begin');
        hideResult();
        document.getElementById('testResults').className = 'test-results';
        return;
      }
      
      // A real language was selected
      isLanguageSelected = true;
      editor.setOption('mode', mode);
      
      // Set default code for the selected language
      const defaultCode = getDefaultCodeForMode(mode);
      editor.setValue(defaultCode);
      
      // Focus the editor so user can start typing
      editor.focus();
      
      console.log('Language changed to CodeMirror mode:', mode, 'Judge0 language:', getJudge0Language());
      
      // Clear any previous results when language changes
      hideResult();
      document.getElementById('testResults').className = 'test-results';
    });

    // Button event listeners
    document.getElementById('runBtn').addEventListener('click', runCode);
    document.getElementById('runTestsBtn').addEventListener('click', runAllTests);
    document.getElementById('resetBtn').addEventListener('click', resetEditor);
  </script>

</body>
</html>