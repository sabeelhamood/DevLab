<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CodeMirror Editor with Judge0</title>

  <!-- CodeMirror core -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>

  <!-- Languages -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script> <!-- Java, C, CPP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/php/php.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 16px;
      background: #ffffff;
    }
    .editor-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .toolbar select {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }
    .toolbar button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .toolbar button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-run {
      background: #3b82f6;
      color: white;
    }
    .btn-run:hover:not(:disabled) {
      background: #2563eb;
    }
    .btn-run-tests {
      background: #10b981;
      color: white;
    }
    .btn-run-tests:hover:not(:disabled) {
      background: #059669;
    }
    .btn-reset {
      background: #6b7280;
      color: white;
    }
    .btn-reset:hover:not(:disabled) {
      background: #4b5563;
    }
    .CodeMirror {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      height: 400px;
      font-size: 14px;
    }
    .result-container {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    .result-container.show {
      display: block;
    }
    .result-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    .result-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
    .result-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #3b82f6;
    }
    .test-results {
      margin-top: 16px;
      display: none;
    }
    .test-results.show {
      display: block;
    }
    .test-result-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    .test-result-passed {
      background: #d1fae5;
      border-color: #10b981;
    }
    .test-result-failed {
      background: #fee2e2;
      border-color: #ef4444;
    }
    .test-result-header {
      font-weight: 600;
      margin-bottom: 8px;
    }
    .test-result-details {
      font-size: 13px;
      margin-top: 8px;
    }
    .test-result-details pre {
      margin: 4px 0;
      padding: 8px;
      background: #f3f4f6;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="editor-container">
    <div class="toolbar">
  <select id="languageSelect">
        <option value="" selected disabled>Select Language</option>
    <option value="javascript">JavaScript</option>
    <option value="python">Python</option>
    <option value="text/x-csrc">C</option>
    <option value="text/x-c++src">C++</option>
    <option value="text/x-java">Java</option>
    <option value="php">PHP</option>
    <option value="xml">HTML / XML</option>
    <option value="css">CSS</option>
  </select>
      <button id="runBtn" class="btn-run">â–¶ Run</button>
      <button id="runTestsBtn" class="btn-run-tests">ðŸ§ª Run All Tests</button>
      <button id="resetBtn" class="btn-reset">â†» Reset</button>
    </div>

    <textarea id="editor">// Please select a programming language to begin</textarea>

    <div id="resultContainer" class="result-container"></div>

    <div id="testResults" class="test-results"></div>
  </div>

  <script>
    // Initialize test cases (will be injected by buildCodeMirrorTemplateForQuestion)
    const tests = [];
    
    // Initialize expectsReturn flag (will be injected by buildCodeMirrorTemplateForQuestion)
    const expectsReturn = false;

    // Create editor in neutral state (no language selected yet)
    const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
      lineNumbers: true,
      mode: null, // No syntax highlighting until language is selected
      theme: "default",
      readOnly: false
    });
    
    let isLanguageSelected = false;

    // Map CodeMirror modes to Judge0 language names
    const languageMap = {
      'javascript': 'javascript',
      'python': 'python',
      'text/x-csrc': 'c',
      'text/x-c++src': 'cpp',
      'text/x-java': 'java',
      'php': 'php',
      'xml': 'xml',
      'css': 'css'
    };

    // Get current Judge0 language from CodeMirror mode
    function getJudge0Language() {
      const mode = editor.getOption('mode');
      if (!mode) {
        throw new Error('Please select a programming language first');
      }
      const judge0Lang = languageMap[mode] || 'javascript';
      console.log('CodeMirror mode:', mode, '-> Judge0 language:', judge0Lang);
      return judge0Lang;
    }
    
    // Get default code for a specific CodeMirror mode
    function getDefaultCodeForMode(mode) {
      const defaultCodes = {
        'javascript': 'console.log("Hello!");',
        'python': 'print("Hello!")',
        'text/x-csrc': '#include <stdio.h>\n\nint main() {\n    printf("Hello!\\n");\n    return 0;\n}',
        'text/x-c++src': '#include <iostream>\n\nint main() {\n    std::cout << "Hello!" << std::endl;\n    return 0;\n}',
        'text/x-java': 'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello!");\n    }\n}',
        'php': '<?php\necho "Hello!";\n?>',
        'xml': '<html>\n  <body>Hello!</body>\n</html>',
        'css': 'body { color: blue; }'
      };
      return defaultCodes[mode] || 'console.log("Hello!");';
    }

    // Expose getCode function to parent window
    window.getCode = function() {
      return editor.getValue();
    };

    // Get API base URL from parent window or construct from location
    function getApiBaseUrl() {
      try {
        if (window.parent && window.parent.__DEVLAB_API_BASE__) {
          return window.parent.__DEVLAB_API_BASE__;
        }
      } catch (e) {
        // Cross-origin restriction, fall through
      }
      
      // Fallback: construct from current location
      const currentUrl = window.location.href;
      if (currentUrl.includes('localhost') || currentUrl.includes('127.0.0.1')) {
        return 'http://localhost:3000';
      }
      // Try to extract base from parent if accessible
      try {
        if (window.parent && window.parent.location) {
          const parentOrigin = window.parent.location.origin;
          return parentOrigin;
        }
      } catch (e) {
        // Cross-origin restriction
      }
      return '';
    }

    // Build API URL
    function buildUrl(path) {
      const base = getApiBaseUrl();
      if (!path) return '';
      if (/^https?:\/\//i.test(path)) return path;
      const normalized = path.startsWith('/') ? path : '/' + path;
      return base ? (base.replace(/\/+$/, '') + normalized) : normalized;
    }

    // Get service headers from parent window
    function getServiceHeaders() {
      try {
        if (window.parent && window.parent.__DEVLAB_SERVICE_HEADERS) {
          const headers = window.parent.__DEVLAB_SERVICE_HEADERS;
          if (typeof headers === 'object') {
            return { ...headers };
          }
        }
      } catch (e) {
        // Cross-origin restriction
      }
      return {};
    }

    // Display result message
    function showResult(message, type = 'info') {
      const container = document.getElementById('resultContainer');
      container.textContent = message;
      container.className = 'result-container show result-' + type;
    }

    // Hide result
    function hideResult() {
      const container = document.getElementById('resultContainer');
      container.className = 'result-container';
    }

    // Render test results
    function renderTestResults(results) {
      const container = document.getElementById('testResults');
      container.innerHTML = '';
      
      if (!results || results.length === 0) {
        container.className = 'test-results';
        return;
      }

      container.className = 'test-results show';

      const total = results.length;
      const passed = results.filter(r => r.passed).length;

      const summary = document.createElement('div');
      summary.style.cssText = 'font-weight: 600; font-size: 16px; margin-bottom: 12px; padding: 12px; background: #f3f4f6; border-radius: 6px;';
      summary.textContent = `Test Results: ${passed}/${total} tests passed`;
      container.appendChild(summary);

      results.forEach((result, index) => {
        const item = document.createElement('div');
        item.className = 'test-result-item ' + (result.passed ? 'test-result-passed' : 'test-result-failed');
        
        const header = document.createElement('div');
        header.className = 'test-result-header';
        header.textContent = `Test ${result.testNumber || (index + 1)}: ${result.passed ? 'âœ… PASSED' : 'âŒ FAILED'}`;
        item.appendChild(header);

        const details = document.createElement('div');
        details.className = 'test-result-details';
        
        if (result.input !== undefined) {
          const inputLabel = document.createElement('div');
          inputLabel.textContent = 'Input:';
          inputLabel.style.cssText = 'font-weight: 600; margin-top: 8px;';
          details.appendChild(inputLabel);
          const inputPre = document.createElement('pre');
          inputPre.textContent = typeof result.input === 'object' ? JSON.stringify(result.input, null, 2) : String(result.input);
          details.appendChild(inputPre);
        }

        if (result.expected !== undefined) {
          const expectedLabel = document.createElement('div');
          expectedLabel.textContent = 'Expected:';
          expectedLabel.style.cssText = 'font-weight: 600; margin-top: 8px;';
          details.appendChild(expectedLabel);
          const expectedPre = document.createElement('pre');
          expectedPre.textContent = typeof result.expected === 'object' ? JSON.stringify(result.expected, null, 2) : String(result.expected);
          details.appendChild(expectedPre);
        }

        if (result.result !== undefined) {
          const resultLabel = document.createElement('div');
          resultLabel.textContent = 'Got:';
          resultLabel.style.cssText = 'font-weight: 600; margin-top: 8px;';
          details.appendChild(resultLabel);
          const resultPre = document.createElement('pre');
          resultPre.textContent = typeof result.result === 'object' ? JSON.stringify(result.result, null, 2) : String(result.result);
          details.appendChild(resultPre);
        }

        if (result.stderr) {
          const errorLabel = document.createElement('div');
          errorLabel.textContent = 'Error:';
          errorLabel.style.cssText = 'font-weight: 600; margin-top: 8px; color: #dc2626;';
          details.appendChild(errorLabel);
          const errorPre = document.createElement('pre');
          errorPre.textContent = result.stderr;
          errorPre.style.cssText = 'color: #dc2626;';
          details.appendChild(errorPre);
        }

        if (result.status) {
          const statusLabel = document.createElement('div');
          statusLabel.textContent = 'Status: ' + result.status;
          statusLabel.style.cssText = 'margin-top: 8px; font-size: 12px; color: #6b7280;';
          details.appendChild(statusLabel);
        }

        item.appendChild(details);
        container.appendChild(item);
      });
    }

    // Run code (check compilation)
    async function runCode() {
      if (!isLanguageSelected) {
        showResult('Please select a programming language first.', 'error');
        return;
      }
      
      const code = editor.getValue();
      if (!code.trim() || code.trim() === '// Please select a programming language to begin') {
        showResult('Please write some code before running.', 'error');
        return;
      }

      const runBtn = document.getElementById('runBtn');
      let language;
      try {
        language = getJudge0Language();
        console.log('[runCode] Executing with language:', language, 'CodeMirror mode:', editor.getOption('mode'));
      } catch (error) {
        showResult(error.message, 'error');
        return;
      }

      try {
        runBtn.disabled = true;
        hideResult();
        document.getElementById('testResults').className = 'test-results';
        showResult('Running code via Judge0...', 'info');

        const endpoint = buildUrl('/api/judge0/execute');
        const headers = {
          'Content-Type': 'application/json',
          ...getServiceHeaders()
        };

        const response = await fetch(endpoint, {
          method: 'POST',
          headers,
          body: JSON.stringify({
            sourceCode: code,
            language: language,
            input: '',
            expectedOutput: null,
            expectsReturn: expectsReturn
          })
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok || data.success === false) {
          throw new Error(data.error || 'Failed to execute code via Judge0');
        }

        const result = data.result || data;
        const stdout = result.stdout || '';
        const stderr = result.stderr || result.compile_output || '';

        if (result.statusId === 3 || result.status === 'Accepted') {
          // Success
          if (stdout) {
            showResult('Output: ' + stdout.trim(), 'success');
          } else if (stderr) {
            showResult('Compiled successfully. Warnings: ' + stderr.trim(), 'info');
          } else {
            showResult('Code executed successfully (no output).', 'success');
          }
        } else {
          // Error
          const errorMsg = stderr || result.status || 'Execution failed';
          showResult('Error: ' + errorMsg, 'error');
        }
      } catch (error) {
        console.error('Judge0 Run Code error:', error);
        showResult('Failed to run code via Judge0: ' + (error.message || 'Unknown error'), 'error');
      } finally {
        runBtn.disabled = false;
      }
    }

    // Run all test cases
    async function runAllTests() {
      if (!isLanguageSelected) {
        showResult('Please select a programming language first.', 'error');
        return;
      }
      
      const code = editor.getValue();
      if (!code.trim() || code.trim() === '// Please select a programming language to begin') {
        showResult('Please write some code before running tests.', 'error');
        return;
      }

      if (!tests || tests.length === 0) {
        showResult('No test cases available for this question.', 'error');
        return;
      }

      const runTestsBtn = document.getElementById('runTestsBtn');
      let language;
      try {
        language = getJudge0Language();
        console.log('[runAllTests] Executing with language:', language, 'CodeMirror mode:', editor.getOption('mode'));
      } catch (error) {
        showResult(error.message, 'error');
        return;
      }

      try {
        runTestsBtn.disabled = true;
        hideResult();
        document.getElementById('testResults').className = 'test-results';
        showResult('Running all tests via Judge0...', 'info');

        // Convert test cases to the format expected by the API
        const testCases = tests.map(tc => ({
          input: tc.input !== undefined ? tc.input : (tc.testInput !== undefined ? tc.testInput : ''),
          expected_output: tc.expectedOutput !== undefined ? tc.expectedOutput : (tc.expected_output !== undefined ? tc.expected_output : (tc.output !== undefined ? tc.output : ''))
        }));

        const endpoint = buildUrl('/api/judge0/test-cases');
        const headers = {
          'Content-Type': 'application/json',
          ...getServiceHeaders()
        };

        const response = await fetch(endpoint, {
          method: 'POST',
          headers,
          body: JSON.stringify({
            sourceCode: code,
            language: language,
            testCases: testCases,
            expectsReturn: expectsReturn
          })
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok || data.success === false) {
          throw new Error(data.error || 'Failed to run Judge0 test-cases');
        }

        const results = Array.isArray(data.results) ? data.results : [];
        renderTestResults(results);

        const total = data.totalTests || results.length;
        const passed = typeof data.passedTests === 'number' ? data.passedTests : results.filter(r => r.passed).length;

        if (total > 0) {
          const allPassed = passed === total;
          const message = 'Judge0: ' + passed + '/' + total + ' tests passed.';
          showResult(message, allPassed ? 'success' : 'error');
        } else {
          showResult('Judge0: No test results returned.', 'error');
        }
      } catch (error) {
        console.error('Judge0 Run All Tests error:', error);
        showResult('Failed to run tests via Judge0: ' + (error.message || 'Unknown error'), 'error');
        document.getElementById('testResults').className = 'test-results';
      } finally {
        runTestsBtn.disabled = false;
      }
    }

    // Reset editor
    function resetEditor() {
      if (!isLanguageSelected) {
        showResult('Please select a programming language first.', 'error');
        return;
      }
      
      const mode = editor.getOption('mode');
      const defaultCode = getDefaultCodeForMode(mode);
      editor.setValue(defaultCode);
      hideResult();
      document.getElementById('testResults').className = 'test-results';
      showResult('Editor reset. You can start fresh.', 'info');
      setTimeout(hideResult, 2000);
    }

    // Change mode based on <select>
    document.getElementById('languageSelect').addEventListener('change', function() {
      const mode = this.value;
      
      if (!mode || mode === '') {
        // "Select Language" was selected - reset to neutral state
        isLanguageSelected = false;
        editor.setOption('mode', null);
        editor.setValue('// Please select a programming language to begin');
        hideResult();
        document.getElementById('testResults').className = 'test-results';
        return;
      }
      
      // A real language was selected
      isLanguageSelected = true;
      editor.setOption('mode', mode);
      
      // Set default code for the selected language
      const defaultCode = getDefaultCodeForMode(mode);
      editor.setValue(defaultCode);
      
      // Focus the editor so user can start typing
      editor.focus();
      
      console.log('Language changed to CodeMirror mode:', mode, 'Judge0 language:', getJudge0Language());
      
      // Clear any previous results when language changes
      hideResult();
      document.getElementById('testResults').className = 'test-results';
    });

    // Button event listeners
    document.getElementById('runBtn').addEventListener('click', runCode);
    document.getElementById('runTestsBtn').addEventListener('click', runAllTests);
    document.getElementById('resetBtn').addEventListener('click', resetEditor);
  </script>

</body>
</html>