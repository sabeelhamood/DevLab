# Question Saving Implementation - Content Studio to Supabase

## Overview
This document describes the implementation of automatic question saving from Content Studio to Supabase database.

## Implementation Details

### 1. Service: `questionStorageService.js`

**Location:** `backend/src/services/questionStorageService.js`

**Purpose:** 
- Automatically saves questions generated by Content Studio to Supabase
- Handles both coding and theoretical questions
- Manages test cases for coding questions
- Stores options and correct answers for theoretical questions

**Key Features:**

#### UUID Generation
- Uses `crypto.randomUUID()` from Node.js for question IDs
- Generates UUID for each question automatically
- Uses `gen_random_uuid()` for test case IDs

#### Connection Handling
- Uses `SUPABASE_URL` from Railway environment variables
- Service role connection (bypasses RLS)
- SSL configuration: `ssl: { rejectUnauthorized: false }`
- Connection pooling for efficient database access

#### Topic Resolution
- Looks up topic by `topic_name` if `topic_id` is not a UUID
- Extracts `course_id` from topic if not provided
- Validates topic exists before saving question
- Throws error if topic doesn't exist (prevents foreign key violations)

#### Safe Insertions
- **Duplicate Prevention:** 
  - Checks for duplicate questions by `question_content` + `topic_id` combination
  - Uses `WHERE NOT EXISTS` clause in SQL
  - Uses `ON CONFLICT DO NOTHING` for UUID conflicts
  
- **Type Casting:**
  - Explicit type casting: `::uuid`, `::bigint`, `::text`, `::jsonb`
  - Ensures data types match database schema exactly

#### Data Storage
- **Question Content:** Stored in `question_content` field
- **Question Type:** 'code' or 'theoretical'
- **Options (Theoretical):** Stored in `metadata` JSONB field as array
- **Correct Answer (Theoretical):** Stored in `metadata` JSONB field
- **Test Cases (Coding):** Stored in separate `testCases` table
- **Source:** Marked as 'content-studio' in metadata
- **Hints:** Stored in metadata
- **Skills:** Stored in metadata (nano_skills, micro_skills)

#### Error Handling
- Graceful error handling - one failure doesn't stop all saves
- Detailed error logging with question preview
- Continues processing remaining questions if one fails
- Logs success/failure count summary

### 2. Integration: `contentStudioRoutes.js`

**Location:** `backend/src/routes/contentStudio/contentStudioRoutes.js`

**Integration Point:**
- Integrated into `generateQuestionsHandler` function
- Runs automatically after questions are generated
- Does not block the response (runs asynchronously)
- Does not affect existing Gemini/Judge0 integration

**Flow:**
1. Questions are generated via Gemini or Assessment Service
2. Questions are saved to temp storage (existing behavior)
3. Questions are automatically saved to Supabase (new behavior)
4. Response is returned to Content Studio (existing behavior)

**Error Handling:**
- Supabase save failures don't break the request
- Questions are still available via temp storage
- Detailed logging for debugging

## Database Schema

### Questions Table
```sql
CREATE TABLE "questions" (
  "question_id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  "topic_id" uuid NOT NULL,
  "course_id" uuid,
  "title" text,
  "question_type" text NOT NULL DEFAULT 'theoretical',
  "question_content" text NOT NULL,
  "difficulty" text NOT NULL DEFAULT 'intermediate',
  "language" text,
  "tags" jsonb NOT NULL DEFAULT '[]'::jsonb,
  "metadata" jsonb,
  "created_at" timestamptz NOT NULL DEFAULT now(),
  "updated_at" timestamptz NOT NULL DEFAULT now()
);
```

### Test Cases Table
```sql
CREATE TABLE "testCases" (
  "testCase_id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  "question_id" uuid NOT NULL,
  "input" text,
  "expected_output" text NOT NULL,
  "explanation" text,
  "metadata" jsonb,
  "created_at" timestamptz NOT NULL DEFAULT now(),
  "updated_at" timestamptz NOT NULL DEFAULT now()
);
```

## Data Flow

### For Coding Questions:
1. Question generated via Gemini
2. Question data extracted (question text, test cases, hints, difficulty, etc.)
3. Topic looked up by topic_name
4. Question saved to `questions` table
5. Test cases saved to `testCases` table
6. Metadata stored in `metadata` JSONB field

### For Theoretical Questions:
1. Question generated via Assessment Service
2. Question data extracted (question text, options, correct answer, etc.)
3. Topic looked up by topic_name
4. Question saved to `questions` table
5. Options and correct_answer stored in `metadata` JSONB field

## Metadata Structure

### For Coding Questions:
```json
{
  "source": "content-studio",
  "original_id": "code_301_1",
  "topic_name": "JavaScript Fundamentals",
  "human_language": "en",
  "nano_skills": ["Variable Declaration", "Data Type Identification"],
  "micro_skills": ["JavaScript Basics"],
  "hints": ["Consider using array methods", "Think about edge cases"],
  "test_cases_count": 3,
  "has_test_cases": true,
  "created_from": "content-studio",
  "created_at": "2024-01-01T12:00:00.000Z"
}
```

### For Theoretical Questions:
```json
{
  "source": "content-studio",
  "original_id": "theoretical_301_1",
  "topic_name": "JavaScript Fundamentals",
  "human_language": "en",
  "nano_skills": ["Variable Declaration"],
  "micro_skills": ["JavaScript Basics"],
  "hints": [],
  "options": [
    {"label": "A", "text": "Option A"},
    {"label": "B", "text": "Option B"},
    {"label": "C", "text": "Option C"},
    {"label": "D", "text": "Option D"}
  ],
  "correct_answer": "A",
  "has_options": true,
  "question_format": "multiple_choice",
  "created_from": "content-studio",
  "created_at": "2024-01-01T12:00:00.000Z"
}
```

## Requirements Met

✅ **Automatic Saving:** Questions are saved automatically when generated
✅ **No Manual Intervention:** Runs automatically without user interaction
✅ **Safe Insertions:** Duplicate prevention and type casting
✅ **Connection Handling:** Uses Railway SUPABASE_URL with SSL
✅ **Service Role:** Uses service role credentials to bypass RLS
✅ **Error Handling:** Graceful error handling, doesn't break request flow
✅ **Verification:** Logs saved question IDs and content for debugging
✅ **No Breaking Changes:** Doesn't affect Gemini/Judge0 integration
✅ **Works Locally and on Railway:** Uses environment variables for connection

## Prerequisites

### Database Requirements:
1. **Topics must exist in database:**
   - Questions require a valid `topic_id` (UUID)
   - Topics must exist in `topics` table
   - Topics can be looked up by `topic_name`

2. **Foreign Key Constraints:**
   - `topic_id` must reference existing topic
   - `course_id` can be null (optional)
   - Test cases require valid `question_id`

### Environment Variables:
- `SUPABASE_URL` - Must be set in Railway environment variables
- Format: `postgresql://[user]:[password]@[host]:[port]/[database]`
- Should contain service role credentials

## Usage

### Automatic Operation
Questions are saved automatically when:
1. User accesses Content Studio (https://dev-lab-three.vercel.app/)
2. Questions are generated via `/api/content-studio/generate-questions`
3. Questions are successfully generated by Gemini or Assessment Service

### Manual Testing
To test the functionality:
1. Generate questions via Content Studio
2. Check Railway logs for save messages
3. Verify questions in Supabase `questions` table
4. Check test cases in `testCases` table (for coding questions)

## Logging

### Success Messages:
```
✅ Question saved to Supabase: [question_id]
   Type: [code|theoretical]
   Content: [question content preview]...
```

### Warning Messages:
```
⚠️ Duplicate question found, skipping insertion: [question_id]
⚠️ Topic not found in database for topic_name: "[topic_name]"
```

### Error Messages:
```
❌ Error saving question to Supabase: [error message]
   Question data: [question data JSON]
   Metadata: [metadata JSON]
```

## Troubleshooting

### Questions Not Saving:
1. **Check Railway logs** for error messages
2. **Verify SUPABASE_URL** is set in Railway environment variables
3. **Check topic exists** in database - questions require valid topic
4. **Check permissions** - service role should have INSERT permissions
5. **Check RLS policies** - service role should bypass RLS

### Topic Not Found:
- **Solution:** Create topic in database first
- **Or:** Ensure topic_name matches existing topic in database
- **Note:** Questions cannot be saved without a valid topic

### Duplicate Questions:
- **Expected behavior:** Duplicate questions are skipped
- **Check:** Verify question content is unique per topic
- **Note:** Same question can exist for different topics

## Next Steps

1. **Verify Topics Exist:**
   - Ensure all Content Studio topics exist in database
   - Topics can be created via Topics API or SQL

2. **Monitor Logs:**
   - Check Railway logs after question generation
   - Verify questions are being saved successfully

3. **Verify Data:**
   - Check Supabase `questions` table for saved questions
   - Check `testCases` table for coding question test cases
   - Verify metadata contains correct information

4. **Test End-to-End:**
   - Generate questions via Content Studio
   - Verify questions appear in Supabase
   - Check question content, metadata, and test cases

## Notes

- Questions are saved asynchronously - doesn't block API response
- Save failures don't affect question generation
- Questions are still available via temp storage even if Supabase save fails
- Service uses same connection pattern as main application
- SSL is properly configured for Supabase connections
- All database operations use parameterized queries (SQL injection prevention)

